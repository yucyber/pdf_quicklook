# PDF é¢„è§ˆæ’ä»¶ - å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®ä»‹ç»](#é¡¹ç›®ä»‹ç»)
2. [æŠ€æœ¯å‡†å¤‡](#æŠ€æœ¯å‡†å¤‡)
3. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
4. [è¿è¡Œé¡¹ç›®](#è¿è¡Œé¡¹ç›®)
5. [ä»£ç è¯¦è§£](#ä»£ç è¯¦è§£)
6. [é¢è¯•å‡†å¤‡](#é¢è¯•å‡†å¤‡)
7. [æ‰©å±•åŠŸèƒ½](#æ‰©å±•åŠŸèƒ½)

---

## é¡¹ç›®ä»‹ç»

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ PDF é¢„è§ˆæ’ä»¶é¡¹ç›®ï¼ŒåŒ…å«ä¸¤ä¸ªç‰ˆæœ¬ï¼š

- **Vue3 ç‰ˆæœ¬**ï¼šä½¿ç”¨ç°ä»£åŒ–çš„ Vue3 æ¡†æ¶å’Œ Composition API
- **åŸç”Ÿ JS ç‰ˆæœ¬**ï¼šçº¯ JavaScript å®ç°ï¼Œå±•ç¤ºåŸç”Ÿå¼€å‘èƒ½åŠ›

### æ ¸å¿ƒåŠŸèƒ½

âœ… PDF æ–‡ä»¶åŠ è½½ä¸é¢„è§ˆ
âœ… ç¿»é¡µæ§åˆ¶ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ/è·³è½¬ï¼‰
âœ… ç¼©æ”¾åŠŸèƒ½ï¼ˆæ”¾å¤§/ç¼©å°/é‡ç½®ï¼‰
âœ… é¡µé¢æ—‹è½¬ï¼ˆ90 åº¦æ—‹è½¬ï¼‰
âœ… ç¼©ç•¥å›¾å¯¼èˆª
âœ… å“åº”å¼è®¾è®¡
âœ… é”®ç›˜å¿«æ·é”®

---

## æŠ€æœ¯å‡†å¤‡

### éœ€è¦æŒæ¡çš„æŠ€æœ¯

#### åŸºç¡€çŸ¥è¯†

- HTML5 & CSS3
- JavaScript ES6+ï¼ˆç®­å¤´å‡½æ•°ã€Promiseã€async/awaitã€æ¨¡å—åŒ–ï¼‰
- DOM æ“ä½œå’Œäº‹ä»¶å¤„ç†

#### Vue3 ç›¸å…³ï¼ˆVue ç‰ˆæœ¬ï¼‰

- Composition APIï¼ˆrefã€reactiveã€computedã€watchï¼‰
- ç»„ä»¶å¼€å‘
- ç”Ÿå‘½å‘¨æœŸé’©å­

#### å·¥å…·é“¾

- Node.js å’Œ npm
- Viteï¼ˆæ„å»ºå·¥å…·ï¼‰
- Gitï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰

#### æ ¸å¿ƒåº“

- **PDF.js**ï¼šMozilla å¼€å‘çš„ PDF æ¸²æŸ“å¼•æ“
- Canvas APIï¼šç”¨äº PDF é¡µé¢æ¸²æŸ“

---

## å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡

1. **å®‰è£… Node.js**

   - è®¿é—® https://nodejs.org/
   - ä¸‹è½½å¹¶å®‰è£… LTS ç‰ˆæœ¬ï¼ˆæ¨è v18 æˆ– v20ï¼‰
   - éªŒè¯å®‰è£…ï¼š
     ```bash
     node -v
     npm -v
     ```

2. **å®‰è£…ä»£ç ç¼–è¾‘å™¨**
   - æ¨èä½¿ç”¨ VS Code
   - å®‰è£… Vue ç›¸å…³æ’ä»¶ï¼šVolarã€ESLint

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Vue3 ç‰ˆæœ¬

```bash
# 1. è¿›å…¥Vue3é¡¹ç›®ç›®å½•
cd vue3-version

# 2. å®‰è£…ä¾èµ–
npm install

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 4. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ http://localhost:3000
```

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨åŸç”Ÿ JS ç‰ˆæœ¬

```bash
# 1. è¿›å…¥åŸç”ŸJSé¡¹ç›®ç›®å½•
cd vanilla-js-version

# 2. å®‰è£…ä¾èµ–ï¼ˆä¸»è¦æ˜¯PDF.jsï¼‰
npm install

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 4. æµè§ˆå™¨æ‰“å¼€ http://localhost:3000
```

### ç¬¬å››æ­¥ï¼šæµ‹è¯•åŠŸèƒ½

1. **ä¸Šä¼  PDF æ–‡ä»¶**

   - ç‚¹å‡»"é€‰æ‹© PDF æ–‡ä»¶"æŒ‰é’®
   - é€‰æ‹©æœ¬åœ° PDF æ–‡ä»¶

2. **ä½¿ç”¨ç¤ºä¾‹ PDF**

   - ç‚¹å‡»"åŠ è½½ç¤ºä¾‹ PDF"
   - è‡ªåŠ¨åŠ è½½åœ¨çº¿ç¤ºä¾‹æ–‡ä»¶

3. **æµ‹è¯•æ‰€æœ‰åŠŸèƒ½**
   - âœ… ç¿»é¡µï¼šç‚¹å‡»å·¥å…·æ æŒ‰é’®æˆ–ä½¿ç”¨é”®ç›˜æ–¹å‘é”®
   - âœ… ç¼©æ”¾ï¼šç‚¹å‡»æ”¾å¤§/ç¼©å°æŒ‰é’®æˆ–ä½¿ç”¨+/-é”®
   - âœ… æ—‹è½¬ï¼šç‚¹å‡»æ—‹è½¬æŒ‰é’®
   - âœ… è·³è½¬ï¼šè¾“å…¥é¡µç åæŒ‰å›è½¦
   - âœ… ç¼©ç•¥å›¾ï¼šç‚¹å‡»ç¼©ç•¥å›¾æŒ‰é’®æŸ¥çœ‹

---

## ä»£ç è¯¦è§£

### 1. PDF.js æ ¸å¿ƒåŸç†ä¸é«˜çº§é…ç½®

#### 1.1 å®Œæ•´çš„PDF.jsé…ç½®ä¸åˆå§‹åŒ–

```javascript
import * as pdfjsLib from 'pdfjs-dist';
import pdfjsWorker from 'pdfjs-dist/build/pdf.worker.entry?url'; // Viteç¯å¢ƒä¸‹çš„æ­£ç¡®å¯¼å…¥æ–¹å¼

// 1. é…ç½®Workerï¼ˆå…³é”®æ­¥éª¤ï¼‰
pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker;

// 2. é«˜çº§é…ç½®é€‰é¡¹
const pdfOptions = {
  // æºæ•°æ®ï¼ˆURLã€ArrayBufferæˆ–DocumentInitParametersï¼‰
  url: pdfUrl,
  
  // å¯†ç ä¿æŠ¤PDFçš„å¤„ç†
  password: pdfPassword,
  
  // æ€§èƒ½ä¼˜åŒ–é…ç½®
  cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/', // æ”¯æŒä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
  cMapPacked: true,
  
  // åŠ è½½é…ç½®
  enableXfa: true, // æ”¯æŒXFAè¡¨å•
  nativeImageDecoderSupport: 'display', // åŸç”Ÿå›¾åƒè§£ç å™¨æ”¯æŒ
  disableFontFace: false, // æ˜¯å¦ç¦ç”¨å­—ä½“åŠ è½½
  
  // æ¸²æŸ“é…ç½®
  renderInteractiveForms: true, // æ¸²æŸ“äº¤äº’å¼è¡¨å•
};

// 3. åˆ›å»ºåŠ è½½ä»»åŠ¡
const loadingTask = pdfjsLib.getDocument(pdfOptions);

// 4. è¿›åº¦ç›‘æ§
loadingTask.onProgress = (progressData) => {
  const { loaded, total } = progressData;
  const percent = Math.round((loaded / total) * 100);
  console.log(`åŠ è½½è¿›åº¦: ${percent}%`);
  // æ›´æ–°UIè¿›åº¦æ¡
};

// 5. åŠ è½½å®Œæˆè·å–æ–‡æ¡£å¯¹è±¡
const pdfDoc = await loadingTask.promise;
console.log(`PDFæ–‡æ¡£å·²åŠ è½½ï¼Œå…±${pdfDoc.numPages}é¡µ`);

// 6. é¡µé¢æ¸²æŸ“å‡½æ•°
async function renderPage(pageNum, scale = 1.5) {
  // è·å–é¡µé¢
  const page = await pdfDoc.getPage(pageNum);
  
  // è®¾ç½®è§†å£
  const viewport = page.getViewport({ 
    scale: scale,
    rotation: 0 // å¯è®¾ç½®æ—‹è½¬è§’åº¦ï¼š0, 90, 180, 270
  });
  
  // å¤„ç†é«˜DPIå±å¹•
  const outputScale = window.devicePixelRatio || 1;
  
  // è·å–Canvaså¹¶è®¾ç½®å°ºå¯¸
  const canvas = document.querySelector(`#page-${pageNum}`);
  if (!canvas) return;
  
  const context = canvas.getContext('2d');
  if (!context) return;
  
  // è®¾ç½®Canvaså®é™…åƒç´ å°ºå¯¸ï¼ˆè€ƒè™‘è®¾å¤‡åƒç´ æ¯”ï¼‰
  canvas.width = Math.floor(viewport.width * outputScale);
  canvas.height = Math.floor(viewport.height * outputScale);
  
  // è®¾ç½®Canvasæ˜¾ç¤ºå°ºå¯¸
  canvas.style.width = `${viewport.width}px`;
  canvas.style.height = `${viewport.height}px`;
  
  // åº”ç”¨ç¼©æ”¾å˜æ¢
  const transform = [outputScale, 0, 0, outputScale, 0, 0];
  context.setTransform(...transform);
  
  // æ¸²æŸ“å‚æ•°
  const renderContext = {
    canvasContext: context,
    viewport: viewport,
    // ä¼˜åŒ–é€‰é¡¹
    enableWebGL: true, // å¯ç”¨WebGLåŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
    renderInteractiveForms: true,
    annotationMode: 2, // 0 = ç¦ç”¨, 1 = ä»…æ˜¾ç¤º, 2 = å¯äº¤äº’
  };
  
  // æ‰§è¡Œæ¸²æŸ“
  const renderTask = page.render(renderContext);
  
  try {
    await renderTask.promise;
    console.log(`é¡µé¢ ${pageNum} æ¸²æŸ“å®Œæˆ`);
  } catch (error) {
    console.error(`é¡µé¢ ${pageNum} æ¸²æŸ“å¤±è´¥:`, error);
    // å®ç°é‡è¯•é€»è¾‘
  }
}

### 2. Vue3 Composition API æ ¸å¿ƒå®ç°

#### 2.1 å®Œæ•´çš„Vue3 PDFé¢„è§ˆç»„ä»¶å®ç°

```vue
<template>
  <div class="pdf-viewer-container">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <button @click="goToPreviousPage" :disabled="currentPage === 1">ä¸Šä¸€é¡µ</button>
      <span>{{ currentPage }} / {{ totalPages }}</span>
      <button @click="goToNextPage" :disabled="currentPage === totalPages">ä¸‹ä¸€é¡µ</button>
      <input v-model.number="pageInput" @keyup.enter="goToPage" type="number" min="1" :max="totalPages" />
      
      <div class="zoom-controls">
        <button @click="zoomOut">-</button>
        <span>{{ zoomPercent }}%</span>
        <button @click="zoomIn">+</button>
        <button @click="resetZoom">é‡ç½®</button>
      </div>
      
      <button @click="rotateClockwise">æ—‹è½¬</button>
      <button @click="toggleThumbnails">ç¼©ç•¥å›¾</button>
    </div>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <p>{{ loadingProgress }}%</p>
    </div>
    
    <!-- é”™è¯¯æç¤º -->
    <div v-else-if="error" class="error-message">
      <p>{{ error.message }}</p>
      <button @click="loadPdf(props.url)">é‡è¯•</button>
    </div>
    
    <!-- PDF æ¸²æŸ“åŒºåŸŸ -->
    <div v-else class="pdf-container">
      <canvas ref="canvasRef" :id="`page-${currentPage}`"></canvas>
    </div>
    
    <!-- ç¼©ç•¥å›¾ä¾§è¾¹æ  -->
    <div v-if="showThumbnails" class="thumbnails-sidebar">
      <div 
        v-for="pageNum in totalPages" 
        :key="pageNum"
        class="thumbnail-item"
        :class="{ active: pageNum === currentPage }"
        @click="goToPage(pageNum)"
      >
        <canvas :ref="el => thumbnailRefs[pageNum] = el"></canvas>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue';
import * as pdfjsLib from 'pdfjs-dist';
import pdfjsWorker from 'pdfjs-dist/build/pdf.worker.entry?url';

// Props
const props = defineProps({
  url: {
    type: String,
    default: ''
  },
  initialScale: {
    type: Number,
    default: 1.5
  }
});

// Emits
const emit = defineEmits(['page-change', 'scale-change', 'error']);

// é…ç½® Worker
pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker;

// å“åº”å¼çŠ¶æ€
const pdfDoc = ref(null);
const currentPage = ref(1);
const totalPages = ref(0);
const scale = ref(props.initialScale);
const rotation = ref(0);
const loading = ref(false);
const loadingProgress = ref(0);
const error = ref(null);
const showThumbnails = ref(false);
const pageInput = ref(1);

// æ¨¡æ¿å¼•ç”¨
const canvasRef = ref(null);
const thumbnailRefs = ref({});

// è®¡ç®—å±æ€§
const zoomPercent = computed(() => Math.round(scale.value * 100));

// é¡µé¢å¯¼èˆªæ–¹æ³•
function goToPreviousPage() {
  if (currentPage.value > 1) {
    currentPage.value--;
    pageInput.value = currentPage.value;
    renderCurrentPage();
    emit('page-change', currentPage.value);
  }
}

function goToNextPage() {
  if (currentPage.value < totalPages.value) {
    currentPage.value++;
    pageInput.value = currentPage.value;
    renderCurrentPage();
    emit('page-change', currentPage.value);
  }
}

function goToPage(pageNum) {
  const page = parseInt(pageNum) || 1;
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page;
    pageInput.value = page;
    renderCurrentPage();
    emit('page-change', page);
  }
}

// ç¼©æ”¾æ§åˆ¶
function zoomIn() {
  scale.value = Math.min(scale.value + 0.1, 5);
  renderCurrentPage();
  emit('scale-change', scale.value);
}

function zoomOut() {
  scale.value = Math.max(scale.value - 0.1, 0.1);
  renderCurrentPage();
  emit('scale-change', scale.value);
}

function resetZoom() {
  scale.value = props.initialScale;
  renderCurrentPage();
  emit('scale-change', scale.value);
}

// æ—‹è½¬æ§åˆ¶
function rotateClockwise() {
  rotation.value = (rotation.value + 90) % 360;
  renderCurrentPage();
}

// åˆ‡æ¢ç¼©ç•¥å›¾
function toggleThumbnails() {
  showThumbnails.value = !showThumbnails.value;
  if (showThumbnails.value && pdfDoc.value) {
    renderThumbnails();
  }
}

// åŠ è½½PDFæ–‡æ¡£
async function loadPdf(url) {
  if (!url) return;
  
  loading.value = true;
  error.value = null;
  loadingProgress.value = 0;
  
  try {
    const loadingTask = pdfjsLib.getDocument({
      url: url,
      cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
      cMapPacked: true
    });
    
    // è¿›åº¦ç›‘æ§
    loadingTask.onProgress = (progressData) => {
      const { loaded, total } = progressData;
      loadingProgress.value = Math.round((loaded / total) * 100);
    };
    
    pdfDoc.value = await loadingTask.promise;
    totalPages.value = pdfDoc.value.numPages;
    currentPage.value = 1;
    pageInput.value = 1;
    
    // æ¸²æŸ“ç¬¬ä¸€é¡µ
    await renderCurrentPage();
    
    // å¦‚æœæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œåˆ™æ¸²æŸ“ç¼©ç•¥å›¾
    if (showThumbnails.value) {
      renderThumbnails();
    }
  } catch (err) {
    error.value = {
      message: `PDFåŠ è½½å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}`
    };
    emit('error', err);
    console.error('PDFåŠ è½½é”™è¯¯:', err);
  } finally {
    loading.value = false;
  }
}

// æ¸²æŸ“å½“å‰é¡µé¢
async function renderCurrentPage() {
  if (!pdfDoc.value || !canvasRef.value) return;
  
  try {
    const page = await pdfDoc.value.getPage(currentPage.value);
    const viewport = page.getViewport({
      scale: scale.value,
      rotation: rotation.value
    });
    
    const canvas = canvasRef.value;
    const context = canvas.getContext('2d');
    
    // å¤„ç†é«˜DPIå±å¹•
    const outputScale = window.devicePixelRatio || 1;
    canvas.width = Math.floor(viewport.width * outputScale);
    canvas.height = Math.floor(viewport.height * outputScale);
    canvas.style.width = `${viewport.width}px`;
    canvas.style.height = `${viewport.height}px`;
    
    const transform = [outputScale, 0, 0, outputScale, 0, 0];
    context.setTransform(...transform);
    
    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;
    
  } catch (err) {
    console.error('é¡µé¢æ¸²æŸ“é”™è¯¯:', err);
    error.value = {
      message: `é¡µé¢æ¸²æŸ“å¤±è´¥: ${err.message}`
    };
  }
}

// æ¸²æŸ“ç¼©ç•¥å›¾
async function renderThumbnails() {
  if (!pdfDoc.value) return;
  
  // åªæ¸²æŸ“å¯è§åŒºåŸŸçš„ç¼©ç•¥å›¾æˆ–é¢„åŠ è½½é™„è¿‘å‡ é¡µ
  const renderCount = Math.min(20, totalPages.value); // é™åˆ¶ä¸€æ¬¡æ€§æ¸²æŸ“æ•°é‡
  
  for (let i = 1; i <= renderCount; i++) {
    await renderSingleThumbnail(i);
  }
}

async function renderSingleThumbnail(pageNum) {
  if (!pdfDoc.value || !thumbnailRefs.value[pageNum]) return;
  
  try {
    const page = await pdfDoc.value.getPage(pageNum);
    const viewport = page.getViewport({ scale: 0.2 }); // ç¼©ç•¥å›¾ä½¿ç”¨å°æ¯”ä¾‹
    
    const canvas = thumbnailRefs.value[pageNum];
    const context = canvas.getContext('2d');
    
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;
    
  } catch (err) {
    console.error(`ç¼©ç•¥å›¾${pageNum}æ¸²æŸ“é”™è¯¯:`, err);
  }
}

// é”®ç›˜äº‹ä»¶å¤„ç†
function handleKeydown(event) {
  switch (event.key) {
    case 'ArrowLeft':
      goToPreviousPage();
      break;
    case 'ArrowRight':
      goToNextPage();
      break;
    case '+':
      zoomIn();
      break;
    case '-':
      zoomOut();
      break;
    case '0':
      resetZoom();
      break;
    case 'Escape':
      if (showThumbnails.value) {
        showThumbnails.value = false;
      }
      break;
  }
}

// çª—å£å¤§å°å˜åŒ–å¤„ç†
function handleResize() {
  if (pdfDoc.value) {
    renderCurrentPage();
  }
}

// ç›‘å¬URLå˜åŒ–
watch(
  () => props.url,
  (newUrl, oldUrl) => {
    if (newUrl && newUrl !== oldUrl) {
      loadPdf(newUrl);
    }
  },
  { immediate: true }
);

// ç”Ÿå‘½å‘¨æœŸé’©å­
onMounted(() => {
  window.addEventListener('keydown', handleKeydown);
  window.addEventListener('resize', handleResize);
});

onUnmounted(() => {
  // æ¸…ç†èµ„æº
  window.removeEventListener('keydown', handleKeydown);
  window.removeEventListener('resize', handleResize);
  
  // é‡Šæ”¾PDFæ–‡æ¡£èµ„æº
  if (pdfDoc.value) {
    pdfDoc.value.destroy();
  }
  
  // æ¸…ç©ºå¼•ç”¨
  pdfDoc.value = null;
  canvasRef.value = null;
  thumbnailRefs.value = {};
});
</script>

<style scoped>
.pdf-viewer-container {
  position: relative;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #f5f5f5;
  border-bottom: 1px solid #ddd;
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-left: auto;
}

.pdf-container {
  flex: 1;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  background: #f9f9f9;
}

canvas {
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  background: white;
}

.loading-overlay, .error-message {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(255, 255, 255, 0.9);
  z-index: 100;
}

.thumbnails-sidebar {
  position: absolute;
  left: 0;
  top: 60px;
  bottom: 0;
  width: 200px;
  background: #f0f0f0;
  overflow-y: auto;
  padding: 10px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.thumbnail-item {
  margin-bottom: 10px;
  cursor: pointer;
  border: 2px solid transparent;
}

.thumbnail-item.active {
  border-color: #007bff;
}

.thumbnail-item canvas {
  width: 100%;
  height: auto;
}

@media (max-width: 768px) {
  .toolbar {
    flex-wrap: wrap;
  }
  
  .zoom-controls {
    margin-left: 0;
    margin-top: 5px;
  }
  
  .thumbnails-sidebar {
    width: 150px;
  }
}
</style>

### 3. åŸç”Ÿ JS ç±»å°è£…å®ç°

#### 3.1 å®Œæ•´çš„PDFé¢„è§ˆå™¨ç±»å°è£…

```javascript
/**
 * PDFé¢„è§ˆå™¨æ ¸å¿ƒç±» - åŸç”ŸJavaScriptå®ç°
 * æä¾›å®Œæ•´çš„PDFæ–‡æ¡£åŠ è½½ã€æ¸²æŸ“ã€äº¤äº’å’Œæ€§èƒ½ä¼˜åŒ–åŠŸèƒ½
 */
class PDFViewer {
  /**
   * æ„é€ å‡½æ•°
   * @param {Object} options - é…ç½®é€‰é¡¹
   * @param {string} options.containerId - å®¹å™¨å…ƒç´ ID
   * @param {string} options.url - PDFæ–‡ä»¶URL
   * @param {number} options.initialScale - åˆå§‹ç¼©æ”¾æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º1.5
   * @param {Object} options.workerOptions - Workeré…ç½®é€‰é¡¹
   * @param {Object} options.callbacks - å›è°ƒå‡½æ•°é›†åˆ
   */
  constructor(options = {}) {
    // åˆå¹¶é»˜è®¤é€‰é¡¹
    this.options = {
      containerId: 'pdf-container',
      url: '',
      initialScale: 1.5,
      workerOptions: {
        workerSrc: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js',
        cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
        cMapPacked: true
      },
      callbacks: {
        onPageChange: () => {},
        onScaleChange: () => {},
        onLoadStart: () => {},
        onLoadProgress: () => {},
        onLoadComplete: () => {},
        onError: () => {}
      },
      ...options
    };

    // åˆå§‹åŒ–PDF.js
    this._initPDFJS();
    
    // åˆå§‹åŒ–çŠ¶æ€
    this._initState();
    
    // åˆ›å»ºDOMç»“æ„
    this._createDOM();
    
    // ç»‘å®šäº‹ä»¶
    this._bindEvents();
    
    // å¦‚æœæä¾›äº†URLï¼Œåˆ™åŠ è½½PDF
    if (this.options.url) {
      this.loadPDF(this.options.url);
    }
  }

  /**
   * åˆå§‹åŒ–PDF.jsåº“
   * @private
   */
  _initPDFJS() {
    // å¯¼å…¥PDF.jsåº“
    if (!window.pdfjsLib) {
      throw new Error('PDF.js library is not loaded. Please include pdf.js before initializing the PDFViewer.');
    }
    
    this.pdfjsLib = window.pdfjsLib;
    
    // é…ç½®Worker
    this.pdfjsLib.GlobalWorkerOptions.workerSrc = this.options.workerOptions.workerSrc;
  }

  /**
   * åˆå§‹åŒ–çŠ¶æ€
   * @private
   */
  _initState() {
    this.pdfDoc = null;
    this.currentPage = 1;
    this.totalPages = 0;
    this.scale = this.options.initialScale;
    this.rotation = 0;
    this.loading = false;
    this.loadingProgress = 0;
    this.error = null;
    this.showThumbnails = false;
    
    // ç¼“å­˜ç®¡ç†
    this.pageCache = new Map(); // é¡µé¢ç¼“å­˜
    this.thumbnailCache = new Map(); // ç¼©ç•¥å›¾ç¼“å­˜
    this.maxCacheSize = 5; // æœ€å¤§ç¼“å­˜é¡µæ•°
    
    // æ€§èƒ½ä¼˜åŒ–
    this._isRendering = false;
    this._pendingRender = null;
    this._devicePixelRatio = window.devicePixelRatio || 1;
  }

  /**
   * åˆ›å»ºDOMç»“æ„
   * @private
   */
  _createDOM() {
    const container = document.getElementById(this.options.containerId);
    if (!container) {
      throw new Error(`Container element with id "${this.options.containerId}" not found.`);
    }
    
    // æ¸…é™¤å®¹å™¨å†…å®¹
    container.innerHTML = '';
    
    // åˆ›å»ºä¸»å®¹å™¨
    this.viewerContainer = document.createElement('div');
    this.viewerContainer.className = 'pdf-viewer-container';
    
    // åˆ›å»ºå·¥å…·æ 
    this._createToolbar();
    
    // åˆ›å»ºåŠ è½½è¦†ç›–å±‚
    this._createLoadingOverlay();
    
    // åˆ›å»ºé”™è¯¯æç¤º
    this._createErrorMessage();
    
    // åˆ›å»ºPDFæ¸²æŸ“åŒºåŸŸ
    this._createPDFContainer();
    
    // åˆ›å»ºç¼©ç•¥å›¾ä¾§è¾¹æ 
    this._createThumbnailSidebar();
    
    // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°å®¹å™¨
    container.appendChild(this.viewerContainer);
  }

  /**
   * åˆ›å»ºå·¥å…·æ 
   * @private
   */
  _createToolbar() {
    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';
    
    // å¯¼èˆªæŒ‰é’®
    toolbar.innerHTML = `
      <button id="prev-page" disabled>ä¸Šä¸€é¡µ</button>
      <span id="page-info">1 / 0</span>
      <button id="next-page" disabled>ä¸‹ä¸€é¡µ</button>
      <input id="page-input" type="number" min="1" value="1" style="width: 60px;">
      
      <div class="zoom-controls">
        <button id="zoom-out">-</button>
        <span id="zoom-percent">${Math.round(this.scale * 100)}%</span>
        <button id="zoom-in">+</button>
        <button id="reset-zoom">é‡ç½®</button>
      </div>
      
      <button id="rotate">æ—‹è½¬</button>
      <button id="toggle-thumbnails">ç¼©ç•¥å›¾</button>
    `;
    
    // ä¿å­˜å·¥å…·æ å…ƒç´ å¼•ç”¨
    this.prevPageBtn = toolbar.querySelector('#prev-page');
    this.nextPageBtn = toolbar.querySelector('#next-page');
    this.pageInfoEl = toolbar.querySelector('#page-info');
    this.pageInputEl = toolbar.querySelector('#page-input');
    this.zoomOutBtn = toolbar.querySelector('#zoom-out');
    this.zoomInBtn = toolbar.querySelector('#zoom-in');
    this.resetZoomBtn = toolbar.querySelector('#reset-zoom');
    this.zoomPercentEl = toolbar.querySelector('#zoom-percent');
    this.rotateBtn = toolbar.querySelector('#rotate');
    this.toggleThumbnailsBtn = toolbar.querySelector('#toggle-thumbnails');
    
    this.viewerContainer.appendChild(toolbar);
  }

  /**
   * åˆ›å»ºåŠ è½½è¦†ç›–å±‚
   * @private
   */
  _createLoadingOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.className = 'loading-overlay';
    overlay.style.display = 'none';
    
    overlay.innerHTML = `
      <div class="loading-spinner"></div>
      <p id="loading-progress">0%</p>
    `;
    
    this.loadingProgressEl = overlay.querySelector('#loading-progress');
    this.loadingOverlay = overlay;
    
    this.viewerContainer.appendChild(overlay);
  }

  /**
   * åˆ›å»ºé”™è¯¯æç¤º
   * @private
   */
  _createErrorMessage() {
    const errorEl = document.createElement('div');
    errorEl.id = 'error-message';
    errorEl.className = 'error-message';
    errorEl.style.display = 'none';
    
    errorEl.innerHTML = `
      <p id="error-text">åŠ è½½å¤±è´¥</p>
      <button id="retry-btn">é‡è¯•</button>
    `;
    
    this.errorTextEl = errorEl.querySelector('#error-text');
    this.retryBtn = errorEl.querySelector('#retry-btn');
    this.errorMessageEl = errorEl;
    
    this.viewerContainer.appendChild(errorEl);
  }

  /**
   * åˆ›å»ºPDFæ¸²æŸ“åŒºåŸŸ
   * @private
   */
  _createPDFContainer() {
    const container = document.createElement('div');
    container.className = 'pdf-container';
    
    const canvas = document.createElement('canvas');
    canvas.id = 'pdf-canvas';
    
    container.appendChild(canvas);
    
    this.pdfContainer = container;
    this.canvas = canvas;
    
    this.viewerContainer.appendChild(container);
  }

  /**
   * åˆ›å»ºç¼©ç•¥å›¾ä¾§è¾¹æ 
   * @private
   */
  _createThumbnailSidebar() {
    const sidebar = document.createElement('div');
    sidebar.id = 'thumbnails-sidebar';
    sidebar.className = 'thumbnails-sidebar';
    sidebar.style.display = 'none';
    
    this.thumbnailsContainer = sidebar;
    
    this.viewerContainer.appendChild(sidebar);
  }

  /**
   * ç»‘å®šäº‹ä»¶
   * @private
   */
  _bindEvents() {
    // å·¥å…·æ äº‹ä»¶
    this.prevPageBtn.addEventListener('click', () => this.goToPreviousPage());
    this.nextPageBtn.addEventListener('click', () => this.goToNextPage());
    this.pageInputEl.addEventListener('change', () => this.goToPage(this.pageInputEl.value));
    this.pageInputEl.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        this.goToPage(this.pageInputEl.value);
      }
    });
    
    this.zoomInBtn.addEventListener('click', () => this.zoomIn());
    this.zoomOutBtn.addEventListener('click', () => this.zoomOut());
    this.resetZoomBtn.addEventListener('click', () => this.resetZoom());
    
    this.rotateBtn.addEventListener('click', () => this.rotateClockwise());
    this.toggleThumbnailsBtn.addEventListener('click', () => this.toggleThumbnails());
    
    // é‡è¯•æŒ‰é’®
    this.retryBtn.addEventListener('click', () => this.loadPDF(this.options.url));
    
    // å…¨å±€äº‹ä»¶
    window.addEventListener('keydown', (e) => this._handleKeydown(e));
    window.addEventListener('resize', () => this._handleResize());
  }

  /**
   * åŠ è½½PDFæ–‡æ¡£
   * @param {string} url - PDFæ–‡ä»¶URL
   * @returns {Promise<void>}
   */
  async loadPDF(url) {
    if (!url) {
      throw new Error('PDF URL must be provided');
    }
    
    // æ›´æ–°URL
    this.options.url = url;
    
    // é‡ç½®çŠ¶æ€
    this._showLoading();
    this._hideError();
    this.pdfDoc = null;
    this.totalPages = 0;
    this.currentPage = 1;
    this._updatePageInfo();
    
    // æ¸…ç©ºç¼“å­˜
    this._clearCache();
    
    // è§¦å‘å›è°ƒ
    this.options.callbacks.onLoadStart();
    
    try {
      // åˆ›å»ºåŠ è½½ä»»åŠ¡
      const loadingTask = this.pdfjsLib.getDocument({
        url: url,
        cMapUrl: this.options.workerOptions.cMapUrl,
        cMapPacked: this.options.workerOptions.cMapPacked,
        enableXfa: true, // æ”¯æŒXFAè¡¨å•
        enableScripting: true // å¯ç”¨è„šæœ¬æ”¯æŒ
      });
      
      // è¿›åº¦ç›‘æ§
      loadingTask.onProgress = (progressData) => {
        const { loaded, total } = progressData;
        this.loadingProgress = Math.round((loaded / total) * 100);
        this.loadingProgressEl.textContent = `${this.loadingProgress}%`;
        this.options.callbacks.onLoadProgress(this.loadingProgress);
      };
      
      // åŠ è½½PDFæ–‡æ¡£
      this.pdfDoc = await loadingTask.promise;
      this.totalPages = this.pdfDoc.numPages;
      
      // æ›´æ–°é¡µé¢ä¿¡æ¯
      this._updatePageInfo();
      this.pageInputEl.max = this.totalPages;
      
      // æ¸²æŸ“ç¬¬ä¸€é¡µ
      await this.renderCurrentPage();
      
      // è§¦å‘å›è°ƒ
      this.options.callbacks.onLoadComplete(this.totalPages);
      
      // å¦‚æœæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œåˆ™æ¸²æŸ“ç¼©ç•¥å›¾
      if (this.showThumbnails) {
        this.renderThumbnails();
      }
    } catch (err) {
      console.error('PDFåŠ è½½é”™è¯¯:', err);
      this.error = {
        message: `PDFåŠ è½½å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}`
      };
      
      // æ˜¾ç¤ºé”™è¯¯
      this._showError();
      
      // è§¦å‘é”™è¯¯å›è°ƒ
      this.options.callbacks.onError(err);
    } finally {
      this.loading = false;
      this._hideLoading();
    }
  }

  /**
   * æ¸²æŸ“å½“å‰é¡µé¢
   * @returns {Promise<void>}
   */
  async renderCurrentPage() {
    if (!this.pdfDoc || !this.canvas) return;
    
    // é˜²æŠ–æ¸²æŸ“è¯·æ±‚
    if (this._isRendering) {
      if (this._pendingRender) {
        clearTimeout(this._pendingRender);
      }
      
      this._pendingRender = setTimeout(() => {
        this.renderCurrentPage();
      }, 50);
      
      return;
    }
    
    this._isRendering = true;
    
    try {
      // æ£€æŸ¥ç¼“å­˜
      const cachedPage = this.pageCache.get(`${this.currentPage}-${this.scale}-${this.rotation}`);
      if (cachedPage) {
        this._displayFromCache(cachedPage);
        return;
      }
      
      // è·å–é¡µé¢
      const page = await this.pdfDoc.getPage(this.currentPage);
      
      // è·å–è§†å£
      const viewport = page.getViewport({
        scale: this.scale,
        rotation: this.rotation
      });
      
      // è®¾ç½®Canvaså°ºå¯¸ï¼ˆå¤„ç†é«˜DPIï¼‰
      const outputScale = this._devicePixelRatio;
      this.canvas.width = Math.floor(viewport.width * outputScale);
      this.canvas.height = Math.floor(viewport.height * outputScale);
      this.canvas.style.width = `${viewport.width}px`;
      this.canvas.style.height = `${viewport.height}px`;
      
      // è·å–ä¸Šä¸‹æ–‡
      const context = this.canvas.getContext('2d');
      context.setTransform(outputScale, 0, 0, outputScale, 0, 0);
      
      // æ¸²æŸ“é¡µé¢
      await page.render({
        canvasContext: context,
        viewport: viewport,
        // æ€§èƒ½ä¼˜åŒ–é…ç½®
        intent: 'display',
        renderInteractiveForms: true
      }).promise;
      
      // ç¼“å­˜æ¸²æŸ“ç»“æœ
      this._cachePage(page, viewport);
    } catch (err) {
      console.error('é¡µé¢æ¸²æŸ“é”™è¯¯:', err);
      this.error = {
        message: `é¡µé¢æ¸²æŸ“å¤±è´¥: ${err.message}`
      };
      this._showError();
    } finally {
      this._isRendering = false;
    }
  }

  /**
   * ç¼“å­˜é¡µé¢æ¸²æŸ“ç»“æœ
   * @param {Object} page - PDFé¡µé¢å¯¹è±¡
   * @param {Object} viewport - è§†å£å¯¹è±¡
   * @private
   */
  _cachePage(page, viewport) {
    // å®ç°ç®€å•çš„LRUç¼“å­˜ç­–ç•¥
    if (this.pageCache.size >= this.maxCacheSize) {
      // åˆ é™¤æœ€æ—©ç¼“å­˜çš„é¡µé¢
      const firstKey = this.pageCache.keys().next().value;
      this.pageCache.delete(firstKey);
    }
    
    // è·å–Canvasæ•°æ®ä½œä¸ºç¼“å­˜
    const cacheKey = `${this.currentPage}-${this.scale}-${this.rotation}`;
    const imageData = this.canvas.toDataURL('image/png');
    
    this.pageCache.set(cacheKey, {
      pageNumber: this.currentPage,
      scale: this.scale,
      rotation: this.rotation,
      viewport: viewport,
      imageData: imageData,
      timestamp: Date.now()
    });
  }

  /**
   * ä»ç¼“å­˜æ˜¾ç¤ºé¡µé¢
   * @param {Object} cachedPage - ç¼“å­˜çš„é¡µé¢æ•°æ®
   * @private
   */
  _displayFromCache(cachedPage) {
    const context = this.canvas.getContext('2d');
    const image = new Image();
    
    image.onload = () => {
      // è®¾ç½®Canvaså°ºå¯¸
      this.canvas.width = Math.floor(cachedPage.viewport.width * this._devicePixelRatio);
      this.canvas.height = Math.floor(cachedPage.viewport.height * this._devicePixelRatio);
      this.canvas.style.width = `${cachedPage.viewport.width}px`;
      this.canvas.style.height = `${cachedPage.viewport.height}px`;
      
      // ç»˜åˆ¶ç¼“å­˜å›¾åƒ
      const outputScale = this._devicePixelRatio;
      context.setTransform(outputScale, 0, 0, outputScale, 0, 0);
      context.drawImage(image, 0, 0, cachedPage.viewport.width, cachedPage.viewport.height);
    };
    
    image.src = cachedPage.imageData;
  }

  /**
   * æ¸²æŸ“ç¼©ç•¥å›¾
   */
  renderThumbnails() {
    if (!this.pdfDoc || !this.thumbnailsContainer) return;
    
    // æ¸…ç©ºç¼©ç•¥å›¾å®¹å™¨
    this.thumbnailsContainer.innerHTML = '';
    
    // åªæ¸²æŸ“éƒ¨åˆ†ç¼©ç•¥å›¾ä»¥æé«˜æ€§èƒ½
    const renderCount = Math.min(50, this.totalPages);
    
    for (let i = 1; i <= renderCount; i++) {
      this._createThumbnailItem(i);
    }
    
    // å¯¹äºé¡µæ•°è¾ƒå¤šçš„æ–‡æ¡£ï¼Œæ·»åŠ æ‡’åŠ è½½
    if (this.totalPages > renderCount) {
      this.thumbnailsContainer.addEventListener('scroll', () => this._lazyLoadThumbnails());
    }
  }

  /**
   * åˆ›å»ºå•ä¸ªç¼©ç•¥å›¾é¡¹
   * @param {number} pageNum - é¡µç 
   * @private
   */
  async _createThumbnailItem(pageNum) {
    const thumbnailItem = document.createElement('div');
    thumbnailItem.className = `thumbnail-item ${pageNum === this.currentPage ? 'active' : ''}`;
    thumbnailItem.dataset.page = pageNum;
    
    const canvas = document.createElement('canvas');
    canvas.className = 'thumbnail-canvas';
    canvas.dataset.page = pageNum;
    
    thumbnailItem.appendChild(canvas);
    this.thumbnailsContainer.appendChild(thumbnailItem);
    
    // ç‚¹å‡»ç¼©ç•¥å›¾è·³è½¬åˆ°å¯¹åº”é¡µé¢
    thumbnailItem.addEventListener('click', () => this.goToPage(pageNum));
    
    // æ¸²æŸ“ç¼©ç•¥å›¾
    await this._renderThumbnail(pageNum, canvas);
  }

  /**
   * æ¸²æŸ“å•ä¸ªç¼©ç•¥å›¾
   * @param {number} pageNum - é¡µç 
   * @param {HTMLCanvasElement} canvas - Canvaså…ƒç´ 
   * @private
   */
  async _renderThumbnail(pageNum, canvas) {
    // æ£€æŸ¥ç¼“å­˜
    const cachedThumbnail = this.thumbnailCache.get(pageNum);
    if (cachedThumbnail && canvas.isConnected) {
      const context = canvas.getContext('2d');
      const image = new Image();
      
      image.onload = () => {
        if (canvas.isConnected) {
          canvas.width = cachedThumbnail.width;
          canvas.height = cachedThumbnail.height;
          context.drawImage(image, 0, 0);
        }
      };
      
      image.src = cachedThumbnail.imageData;
      return;
    }
    
    try {
      const page = await this.pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 0.15 });
      
      if (!canvas.isConnected) return; // æ£€æŸ¥Canvasæ˜¯å¦ä»ç„¶åœ¨DOMä¸­
      
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      
      const context = canvas.getContext('2d');
      
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;
      
      // ç¼“å­˜ç¼©ç•¥å›¾
      if (canvas.isConnected) {
        this.thumbnailCache.set(pageNum, {
          width: viewport.width,
          height: viewport.height,
          imageData: canvas.toDataURL('image/png')
        });
      }
    } catch (err) {
      console.error(`ç¼©ç•¥å›¾${pageNum}æ¸²æŸ“é”™è¯¯:`, err);
    }
  }

  /**
   * æ‡’åŠ è½½ç¼©ç•¥å›¾
   * @private
   */
  _lazyLoadThumbnails() {
    // å®ç°ç¼©ç•¥å›¾æ‡’åŠ è½½é€»è¾‘
    const container = this.thumbnailsContainer;
    const scrollTop = container.scrollTop;
    const containerHeight = container.clientHeight;
    
    // è·å–å½“å‰å¯è§åŒºåŸŸå†…å°šæœªæ¸²æŸ“çš„ç¼©ç•¥å›¾
    const unrenderedItems = container.querySelectorAll('.thumbnail-item:not([data-rendered])');
    
    unrenderedItems.forEach(item => {
      const rect = item.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      if (rect.top <= containerRect.bottom + 100 && rect.bottom >= containerRect.top - 100) {
        const pageNum = parseInt(item.dataset.page);
        const canvas = item.querySelector('canvas');
        
        if (canvas && !item.dataset.rendered) {
          item.dataset.rendered = 'true';
          this._renderThumbnail(pageNum, canvas);
        }
      }
    });
  }

  /**
   * ä¸Šä¸€é¡µ
   */
  goToPreviousPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this._updatePageInfo();
      this.renderCurrentPage();
      this._updateThumbnailActiveState();
      this.options.callbacks.onPageChange(this.currentPage);
    }
  }

  /**
   * ä¸‹ä¸€é¡µ
   */
  goToNextPage() {
    if (this.currentPage < this.totalPages) {
      this.currentPage++;
      this._updatePageInfo();
      this.renderCurrentPage();
      this._updateThumbnailActiveState();
      this.options.callbacks.onPageChange(this.currentPage);
    }
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šé¡µé¢
   * @param {number} pageNum - é¡µç 
   */
  goToPage(pageNum) {
    const page = parseInt(pageNum) || 1;
    
    if (page >= 1 && page <= this.totalPages) {
      this.currentPage = page;
      this._updatePageInfo();
      this.renderCurrentPage();
      this._updateThumbnailActiveState();
      this.options.callbacks.onPageChange(this.currentPage);
    }
  }

  /**
   * æ”¾å¤§
   */
  zoomIn() {
    this.scale = Math.min(this.scale + 0.1, 5);
    this._updateZoomInfo();
    this.renderCurrentPage();
    this.options.callbacks.onScaleChange(this.scale);
  }

  /**
   * ç¼©å°
   */
  zoomOut() {
    this.scale = Math.max(this.scale - 0.1, 0.1);
    this._updateZoomInfo();
    this.renderCurrentPage();
    this.options.callbacks.onScaleChange(this.scale);
  }

  /**
   * é‡ç½®ç¼©æ”¾
   */
  resetZoom() {
    this.scale = this.options.initialScale;
    this._updateZoomInfo();
    this.renderCurrentPage();
    this.options.callbacks.onScaleChange(this.scale);
  }

  /**
   * é¡ºæ—¶é’ˆæ—‹è½¬
   */
  rotateClockwise() {
    this.rotation = (this.rotation + 90) % 360;
    this.renderCurrentPage();
  }

  /**
   * åˆ‡æ¢ç¼©ç•¥å›¾æ˜¾ç¤º
   */
  toggleThumbnails() {
    this.showThumbnails = !this.showThumbnails;
    
    if (this.showThumbnails) {
      this.thumbnailsContainer.style.display = 'block';
      if (this.pdfDoc) {
        this.renderThumbnails();
      }
    } else {
      this.thumbnailsContainer.style.display = 'none';
    }
  }

  /**
   * æ›´æ–°é¡µé¢ä¿¡æ¯
   * @private
   */
  _updatePageInfo() {
    this.pageInfoEl.textContent = `${this.currentPage} / ${this.totalPages}`;
    this.pageInputEl.value = this.currentPage;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    this.prevPageBtn.disabled = this.currentPage === 1;
    this.nextPageBtn.disabled = this.currentPage === this.totalPages;
  }

  /**
   * æ›´æ–°ç¼©æ”¾ä¿¡æ¯
   * @private
   */
  _updateZoomInfo() {
    this.zoomPercentEl.textContent = `${Math.round(this.scale * 100)}%`;
  }

  /**
   * æ›´æ–°ç¼©ç•¥å›¾æ¿€æ´»çŠ¶æ€
   * @private
   */
  _updateThumbnailActiveState() {
    const activeItem = this.thumbnailsContainer.querySelector('.thumbnail-item.active');
    if (activeItem) {
      activeItem.classList.remove('active');
    }
    
    const newActiveItem = this.thumbnailsContainer.querySelector(`.thumbnail-item[data-page="${this.currentPage}"]`);
    if (newActiveItem) {
      newActiveItem.classList.add('active');
      // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
      newActiveItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  /**
   * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   * @private
   */
  _showLoading() {
    this.loadingOverlay.style.display = 'flex';
  }

  /**
   * éšè—åŠ è½½çŠ¶æ€
   * @private
   */
  _hideLoading() {
    this.loadingOverlay.style.display = 'none';
  }

  /**
   * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
   * @private
   */
  _showError() {
    this.errorTextEl.textContent = this.error?.message || 'åŠ è½½å¤±è´¥';
    this.errorMessageEl.style.display = 'flex';
  }

  /**
   * éšè—é”™è¯¯ä¿¡æ¯
   * @private
   */
  _hideError() {
    this.errorMessageEl.style.display = 'none';
  }

  /**
   * é”®ç›˜äº‹ä»¶å¤„ç†
   * @param {KeyboardEvent} event - é”®ç›˜äº‹ä»¶
   * @private
   */
  _handleKeydown(event) {
    // åªæœ‰å½“PDFå®¹å™¨æœ‰ç„¦ç‚¹æˆ–è€…æ²¡æœ‰è¾“å…¥å…ƒç´ è¢«æ¿€æ´»æ—¶å¤„ç†é”®ç›˜äº‹ä»¶
    if (document.activeElement.tagName === 'INPUT' || 
        document.activeElement.tagName === 'TEXTAREA' || 
        document.activeElement.contentEditable === 'true') {
      return;
    }
    
    switch (event.key) {
      case 'ArrowLeft':
        this.goToPreviousPage();
        break;
      case 'ArrowRight':
        this.goToNextPage();
        break;
      case '+':
      case '=':
        this.zoomIn();
        break;
      case '-':
      case '_':
        this.zoomOut();
        break;
      case '0':
        this.resetZoom();
        break;
      case 'Escape':
        if (this.showThumbnails) {
          this.toggleThumbnails();
        }
        break;
    }
  }

  /**
   * çª—å£å¤§å°å˜åŒ–å¤„ç†
   * @private
   */
  _handleResize() {
    if (this.pdfDoc && !this.loading) {
      this.renderCurrentPage();
    }
    
    // æ›´æ–°è®¾å¤‡åƒç´ æ¯”
    this._devicePixelRatio = window.devicePixelRatio || 1;
  }

  /**
   * æ¸…ç©ºç¼“å­˜
   * @private
   */
  _clearCache() {
    this.pageCache.clear();
    this.thumbnailCache.clear();
  }

  /**
   * é”€æ¯PDFæŸ¥çœ‹å™¨å®ä¾‹
   */
  destroy() {
    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    window.removeEventListener('keydown', (e) => this._handleKeydown(e));
    window.removeEventListener('resize', () => this._handleResize());
    
    // é‡Šæ”¾PDFæ–‡æ¡£èµ„æº
    if (this.pdfDoc) {
      this.pdfDoc.destroy();
    }
    
    // æ¸…ç©ºç¼“å­˜
    this._clearCache();
    
    // æ¸…ç©ºDOMå¼•ç”¨
    if (this.viewerContainer && this.viewerContainer.parentNode) {
      this.viewerContainer.parentNode.removeChild(this.viewerContainer);
    }
    
    // é‡ç½®çŠ¶æ€
    this._initState();
  }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 * 
 * // åˆ›å»ºPDFæŸ¥çœ‹å™¨å®ä¾‹
 * const pdfViewer = new PDFViewer({
 *   containerId: 'pdf-container',
 *   url: 'example.pdf',
 *   initialScale: 1.2,
 *   workerOptions: {
 *     workerSrc: '/path/to/pdf.worker.js'
 *   },
 *   callbacks: {
 *     onPageChange: (pageNum) => console.log('å½“å‰é¡µç :', pageNum),
 *     onLoadProgress: (progress) => console.log('åŠ è½½è¿›åº¦:', progress),
 *     onError: (error) => console.error('å‘ç”Ÿé”™è¯¯:', error)
 *   }
 * });
 * 
 * // æ‰‹åŠ¨åŠ è½½PDF
 * // pdfViewer.loadPDF('another-document.pdf');
 * 
 * // é¡µé¢å¯¼èˆª
 * // pdfViewer.goToPage(5);
 * 
 * // é”€æ¯å®ä¾‹
 * // window.addEventListener('beforeunload', () => {
 * //   pdfViewer.destroy();
 * // });
 */
```

#### 3.2 åŸç”ŸJSç‰ˆæœ¬çš„æ ·å¼å®ç°

```css
/* PDFæŸ¥çœ‹å™¨æ ·å¼ */
.pdf-viewer-container {
  position: relative;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

/* å·¥å…·æ æ ·å¼ */
.toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  background: #f5f5f5;
  border-bottom: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.toolbar button {
  padding: 6px 12px;
  border: 1px solid #ccc;
  background: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.toolbar button:hover:not(:disabled) {
  background: #e9e9e9;
  border-color: #adadad;
}

.toolbar button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.page-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

#page-info {
  font-size: 14px;
  min-width: 80px;
  text-align: center;
}

#page-input {
  width: 60px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
  text-align: center;
}

/* ç¼©æ”¾æ§åˆ¶æ ·å¼ */
.zoom-controls {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-left: auto;
}

#zoom-percent {
  font-size: 14px;
  min-width: 45px;
  text-align: center;
}

/* PDFå®¹å™¨æ ·å¼ */
.pdf-container {
  flex: 1;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  background: #f9f9f9;
  position: relative;
}

#pdf-canvas {
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  background: white;
  transition: transform 0.3s ease;
}

/* åŠ è½½è¦†ç›–å±‚æ ·å¼ */
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(255, 255, 255, 0.9);
  z-index: 100;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
.error-message {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(255, 255, 255, 0.95);
  z-index: 100;
  color: #dc3545;
}

.error-message p {
  margin-bottom: 15px;
  font-size: 16px;
}

.error-message button {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}

.error-message button:hover {
  background: #c82333;
}

/* ç¼©ç•¥å›¾ä¾§è¾¹æ æ ·å¼ */
.thumbnails-sidebar {
  position: absolute;
  left: 0;
  top: 60px;
  bottom: 0;
  width: 200px;
  background: #f0f0f0;
  overflow-y: auto;
  padding: 10px;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  z-index: 50;
}

.thumbnail-item {
  margin-bottom: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 4px;
  transition: all 0.2s ease;
  overflow: hidden;
}

.thumbnail-item:hover {
  transform: scale(1.02);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.thumbnail-item.active {
  border-color: #007bff;
  background: rgba(0, 123, 255, 0.1);
}

.thumbnail-canvas {
  width: 100%;
  height: auto;
  display: block;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .toolbar {
    flex-wrap: wrap;
    padding: 8px 15px;
  }
  
  .zoom-controls {
    margin-left: 0;
    margin-top: 8px;
  }
  
  .thumbnails-sidebar {
    width: 150px;
  }
  
  .pdf-container {
    padding: 10px;
  }
}

@media (max-width: 480px) {
  .toolbar {
    gap: 5px;
  }
  
  .toolbar button {
    padding: 5px 8px;
    font-size: 12px;
  }
  
  #page-info {
    min-width: 60px;
    font-size: 12px;
  }
  
  .thumbnails-sidebar {
    width: 100px;
  }
}
```

#### 3.3 ä½¿ç”¨åŸç”ŸJSç‰ˆæœ¬çš„å®Œæ•´ç¤ºä¾‹

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDFé¢„è§ˆå™¨ - åŸç”ŸJSç‰ˆæœ¬</title>
  <!-- å¼•å…¥PDF.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
  <!-- å¼•å…¥PDFæŸ¥çœ‹å™¨æ ·å¼ -->
  <style>
    /* è¿™é‡Œæ”¾ç½®ä¸Šé¢çš„PDFæŸ¥çœ‹å™¨æ ·å¼ä»£ç  */
    /* ä¸ºäº†ç¤ºä¾‹ç®€æ´ï¼Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥å•ç‹¬å¼•å…¥CSSæ–‡ä»¶ */
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    #app {
      width: 100%;
      height: 100%;
    }
    
    /* å…¶ä»–æ ·å¼... */
  </style>
</head>
<body>
  <div id="app">
    <div id="pdf-container"></div>
  </div>
  
  <!-- å¼•å…¥PDFæŸ¥çœ‹å™¨ç±» -->
  <script>
    // è¿™é‡Œæ”¾ç½®PDFViewerç±»çš„å®Œæ•´ä»£ç 
    // ä¸ºäº†ç¤ºä¾‹ç®€æ´ï¼Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥å•ç‹¬å¼•å…¥JSæ–‡ä»¶
    
    // åˆå§‹åŒ–PDFæŸ¥çœ‹å™¨
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
      if (!window.PDFJS && !window.pdfjsLib) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒPDF.jsï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ã€‚');
        return;
      }
      
      // å®ä¾‹åŒ–PDFæŸ¥çœ‹å™¨
      const pdfViewer = new PDFViewer({
        containerId: 'pdf-container',
        url: 'sample.pdf', // æ›¿æ¢ä¸ºæ‚¨çš„PDFæ–‡ä»¶URL
        initialScale: 1.5,
        workerOptions: {
          workerSrc: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js',
          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
          cMapPacked: true
        },
        callbacks: {
          onPageChange: function(pageNum) {
            console.log('é¡µç åˆ‡æ¢åˆ°:', pageNum);
            document.title = `PDFé¢„è§ˆå™¨ - ç¬¬${pageNum}é¡µ`;
          },
          onScaleChange: function(scale) {
            console.log('ç¼©æ”¾æ¯”ä¾‹:', scale);
          },
          onLoadStart: function() {
            console.log('å¼€å§‹åŠ è½½PDF');
          },
          onLoadProgress: function(progress) {
            console.log('åŠ è½½è¿›åº¦:', progress + '%');
          },
          onLoadComplete: function(totalPages) {
            console.log('PDFåŠ è½½å®Œæˆï¼Œæ€»é¡µæ•°:', totalPages);
          },
          onError: function(error) {
            console.error('PDFåŠ è½½æˆ–æ¸²æŸ“é”™è¯¯:', error);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰é”™è¯¯å¤„ç†é€»è¾‘
          }
        }
      });
      
      // æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
      function setupFileUpload() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.pdf';
        fileInput.style.display = 'none';
        
        // æ·»åŠ ä¸Šä¼ æŒ‰é’®åˆ°å·¥å…·æ 
        const toolbar = document.querySelector('.toolbar');
        if (toolbar) {
          const uploadBtn = document.createElement('button');
          uploadBtn.textContent = 'ä¸Šä¼ PDF';
          uploadBtn.addEventListener('click', function() {
            fileInput.click();
          });
          toolbar.appendChild(uploadBtn);
        }
        
        document.body.appendChild(fileInput);
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file && file.type === 'application/pdf') {
            const fileUrl = URL.createObjectURL(file);
            pdfViewer.loadPDF(fileUrl);
            
            // æ¸…ç†å¯¹è±¡URL
            setTimeout(function() {
              URL.revokeObjectURL(fileUrl);
            }, 60000); // 1åˆ†é’Ÿåæ¸…ç†
          } else {
            alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„PDFæ–‡ä»¶');
          }
        });
      }
      
      // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
      setupFileUpload();
      
      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener('beforeunload', function() {
        if (pdfViewer) {
          pdfViewer.destroy();
        }
      });
    });
  </script>
</body>
</html>
```

```javascript
class PdfViewer {
  constructor(options) {
    this.options = options;
    this.state = {
      currentPage: 1,
      scale: 1.5,
    };
    this.init();
  }

  init() {
    this.createUI();
    this.bindEvents();
    this.loadPdf();
  }

  async loadPdf(url) {
    // PDFåŠ è½½é€»è¾‘
  }

  renderPage(pageNum) {
    // é¡µé¢æ¸²æŸ“é€»è¾‘
  }
}
```

---

## é¢è¯•å‡†å¤‡

### å¯èƒ½è¢«é—®åˆ°çš„é—®é¢˜

#### 1. **é¡¹ç›®ä»‹ç»**

**é—®é¢˜**ï¼šè¯·ä»‹ç»ä¸€ä¸‹è¿™ä¸ª PDF é¢„è§ˆæ’ä»¶é¡¹ç›®ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

- é¡¹ç›®èƒŒæ™¯å’Œç›®æ ‡
- ä½¿ç”¨çš„æŠ€æœ¯æ ˆï¼ˆVue3/åŸç”Ÿ JS + PDF.jsï¼‰
- å®ç°çš„æ ¸å¿ƒåŠŸèƒ½
- æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ

#### 2. **æŠ€æœ¯é€‰å‹**

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆé€‰æ‹© PDF.jsï¼Ÿæœ‰è€ƒè™‘è¿‡å…¶ä»–æ–¹æ¡ˆå—ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

- PDF.js æ˜¯ Mozilla å®˜æ–¹å¼€æºåº“ï¼Œç¨³å®šå¯é 
- çº¯ JavaScript å®ç°ï¼Œè·¨å¹³å°å…¼å®¹æ€§å¥½
- ä¸ä¾èµ–åç«¯ï¼Œå‰ç«¯å³å¯å®Œæˆ PDF æ¸²æŸ“
- ä¹Ÿè€ƒè™‘è¿‡å…¶ä»–æ–¹æ¡ˆï¼š
  - iframe ç›´æ¥åµŒå…¥ï¼ˆåŠŸèƒ½æœ‰é™ï¼‰
  - åç«¯è½¬å›¾ç‰‡ï¼ˆå¢åŠ æœåŠ¡å™¨è´Ÿæ‹…ï¼‰
  - å•†ä¸šåº“ï¼ˆæˆæœ¬è€ƒè™‘ï¼‰

#### 3. **æ€§èƒ½ä¼˜åŒ–**

**é—®é¢˜**ï¼šåœ¨å¤„ç†å¤§ PDF æ–‡ä»¶æ—¶ï¼Œä½ æ˜¯å¦‚ä½•ä¼˜åŒ–æ€§èƒ½çš„ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

- **æ‡’åŠ è½½**ï¼šåªæ¸²æŸ“å½“å‰é¡µé¢ï¼Œä¸é¢„åŠ è½½æ‰€æœ‰é¡µé¢
- **ç¼©ç•¥å›¾ä¼˜åŒ–**ï¼šä½¿ç”¨è¾ƒå°çš„ scale æ¸²æŸ“ç¼©ç•¥å›¾
- **Canvas å¤ç”¨**ï¼šé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯ Canvas
- **é˜²æŠ–èŠ‚æµ**ï¼šç¼©æ”¾ã€æ»šåŠ¨äº‹ä»¶ä½¿ç”¨é˜²æŠ–
- **è™šæ‹Ÿæ»šåŠ¨**ï¼ˆæ‰©å±•ï¼‰ï¼šå¤§æ–‡ä»¶å¯å®ç°è™šæ‹Ÿæ»šåŠ¨

```javascript
// æ‡’åŠ è½½ç¤ºä¾‹
async renderPage(pageNum) {
  // åªæ¸²æŸ“å½“å‰é¡µé¢
  const page = await this.pdfDoc.getPage(pageNum)
  // ... æ¸²æŸ“é€»è¾‘
}

// ç¼©ç•¥å›¾ä½¿ç”¨å°scale
const viewport = page.getViewport({ scale: 0.3 })
```

#### 4. **Vue3 vs Vue2**

**é—®é¢˜**ï¼šä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† Vue3ï¼Œå’Œ Vue2 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

- **Composition API**ï¼šæ›´å¥½çš„é€»è¾‘å¤ç”¨å’Œä»£ç ç»„ç»‡
- **æ€§èƒ½æå‡**ï¼šæ›´å¿«çš„æ¸²æŸ“é€Ÿåº¦ï¼Œæ›´å°çš„åŒ…ä½“ç§¯
- **TypeScript æ”¯æŒ**ï¼šæ›´å¥½çš„ç±»å‹æ¨å¯¼
- **æ–°ç‰¹æ€§**ï¼šTeleportã€Fragmentsã€Suspense ç­‰

#### 5. **é”™è¯¯å¤„ç†**

**é—®é¢˜**ï¼šå¦‚ä½•å¤„ç† PDF åŠ è½½å¤±è´¥çš„æƒ…å†µï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```javascript
try {
  const pdfDoc = await pdfjsLib.getDocument(url).promise;
} catch (error) {
  // 1. è®°å½•é”™è¯¯æ—¥å¿—
  console.error("PDFåŠ è½½å¤±è´¥:", error);

  // 2. ç”¨æˆ·å‹å¥½æç¤º
  alert("PDFåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");

  // 3. è§¦å‘é”™è¯¯å›è°ƒ
  if (this.options.onError) {
    this.options.onError(error);
  }

  // 4. çŠ¶æ€æ¢å¤
  this.loading = false;
}
```

#### 6. **å“åº”å¼è®¾è®¡**

**é—®é¢˜**ï¼šå¦‚ä½•ä¿è¯åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

- ä½¿ç”¨åª’ä½“æŸ¥è¯¢é€‚é…ä¸åŒå±å¹•
- è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆå¯æ‰©å±•ï¼‰
- å·¥å…·æ è‡ªé€‚åº”å¸ƒå±€
- ç¼©æ”¾æ‰‹åŠ¿æ”¯æŒï¼ˆå¯æ‰©å±•ï¼‰

```css
@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
  }
  .thumbnails-sidebar {
    position: absolute;
    z-index: 10;
  }
}
```

### æŠ€æœ¯äº®ç‚¹æ€»ç»“

å‡†å¤‡é¢è¯•æ—¶ï¼Œå¼ºè°ƒè¿™äº›äº®ç‚¹ï¼š

1. **æŠ€æœ¯æ ˆå¤šæ ·æ€§**

   - æ—¢ä¼š Vue3 æ¡†æ¶ï¼Œä¹Ÿèƒ½å†™åŸç”Ÿ JS
   - å±•ç¤ºå…¨æ ˆæ€ç»´å’Œå·¥ç¨‹åŒ–èƒ½åŠ›

2. **ä»£ç è´¨é‡**

   - æ¨¡å—åŒ–è®¾è®¡
   - æ¸…æ™°çš„æ³¨é‡Š
   - é”™è¯¯å¤„ç†å®Œå–„

3. **ç”¨æˆ·ä½“éªŒ**

   - æµç•…çš„äº¤äº’
   - å‹å¥½çš„æç¤º
   - é”®ç›˜å¿«æ·é”®

4. **å¯æ‰©å±•æ€§**

   - æ’ä»¶åŒ–è®¾è®¡
   - é…ç½®é¡¹ä¸°å¯Œ
   - äº‹ä»¶å›è°ƒæœºåˆ¶

5. **é—®é¢˜è§£å†³èƒ½åŠ›**
   - æ€§èƒ½ä¼˜åŒ–æ€è·¯
   - Canvas æ¸²æŸ“ç†è§£
   - å¼‚æ­¥ç¼–ç¨‹æŒæ¡

---

## æ‰©å±•åŠŸèƒ½

å®ŒæˆåŸºç¡€åŠŸèƒ½åï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ è¿™äº›é«˜çº§åŠŸèƒ½æ¥æå‡é¡¹ç›®ç«äº‰åŠ›ï¼š

### 1. æ°´å°åŠŸèƒ½

```javascript
// åœ¨PDFæ¸²æŸ“åæ·»åŠ æ°´å°
function addWatermark(canvas, text) {
  const ctx = canvas.getContext("2d");
  ctx.globalAlpha = 0.2;
  ctx.font = "30px Arial";
  ctx.fillStyle = "#999";
  ctx.rotate((-45 * Math.PI) / 180);
  ctx.fillText(text, 100, 500);
}
```

### 2. æ–‡æœ¬æœç´¢

```javascript
async function searchText(searchTerm) {
  const page = await pdfDoc.getPage(pageNum);
  const textContent = await page.getTextContent();
  // æœç´¢åŒ¹é…é€»è¾‘
}
```

### 3. æ³¨é‡ŠåŠŸèƒ½

- å…è®¸ç”¨æˆ·åœ¨ PDF ä¸Šåšæ ‡è®°
- ä½¿ç”¨ Canvas ç»˜å›¾ API
- ä¿å­˜æ³¨é‡Šæ•°æ®

### 4. ä¸‹è½½åŠŸèƒ½

```javascript
function downloadPdf() {
  const link = document.createElement("a");
  link.href = pdfUrl;
  link.download = "document.pdf";
  link.click();
}
```

### 5. æ‰“å°åŠŸèƒ½

```javascript
function printPdf() {
  window.print();
}
```

### 6. åˆ†ç‰‡åŠ è½½ï¼ˆå¤§æ–‡ä»¶ä¼˜åŒ–ï¼‰

```javascript
// ä½¿ç”¨Rangeè¯·æ±‚åˆ†ç‰‡åŠ è½½
const loadingTask = pdfjsLib.getDocument({
  url: pdfUrl,
  rangeChunkSize: 65536, // 64KB chunks
});
```

### 7. æ‰‹åŠ¿æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰

```javascript
// åŒæŒ‡ç¼©æ”¾
canvas.addEventListener("gesturestart", handleGestureStart);
canvas.addEventListener("gesturechange", handleGestureChange);

// æ»‘åŠ¨ç¿»é¡µ
canvas.addEventListener("touchstart", handleTouchStart);
canvas.addEventListener("touchmove", handleTouchMove);
```

---

## å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [PDF.js å®˜æ–¹æ–‡æ¡£](https://mozilla.github.io/pdf.js/)
- [Vue3 å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/)
- [MDN Canvas API](https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API)

### æ¨èé˜…è¯»

- ã€ŠJavaScript é«˜çº§ç¨‹åºè®¾è®¡ã€‹
- ã€ŠVue.js è®¾è®¡ä¸å®ç°ã€‹
- ã€Šæ·±å…¥ç†è§£ ES6ã€‹

### åœ¨çº¿èµ„æº

- Vue Masteryï¼ˆVue3 æ•™ç¨‹ï¼‰
- freeCodeCampï¼ˆå‰ç«¯è¯¾ç¨‹ï¼‰
- GitHub ä¼˜ç§€å¼€æºé¡¹ç›®

---

## é¡¹ç›®å±•ç¤ºå»ºè®®

### 1. GitHub ä»“åº“

- å®Œå–„çš„ README
- æ¸…æ™°çš„ä»£ç æ³¨é‡Š
- æäº¤è®°å½•è§„èŒƒ
- åœ¨çº¿ Demo é“¾æ¥

### 2. ç®€å†æè¿°

```
PDFé¢„è§ˆæ’ä»¶ï¼ˆä¸ªäººé¡¹ç›®ï¼‰
- ä½¿ç”¨Vue3 + PDF.jså¼€å‘åŠŸèƒ½å®Œæ•´çš„PDFåœ¨çº¿é¢„è§ˆå·¥å…·
- å®ç°ç¿»é¡µã€ç¼©æ”¾ã€æ—‹è½¬ã€ç¼©ç•¥å›¾ç­‰æ ¸å¿ƒåŠŸèƒ½
- å°è£…åŸç”ŸJavaScriptç‰ˆæœ¬ï¼Œå±•ç¤ºè·¨æ¡†æ¶å¼€å‘èƒ½åŠ›
- é‡‡ç”¨å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯è®¿é—®
- æŠ€æœ¯æ ˆï¼šVue3ã€Viteã€Canvas APIã€ES6+
```

### 3. é¢è¯•æ¼”ç¤º

- å‡†å¤‡ä¸€ä¸ªç²¾ç¾çš„ PDF æ–‡ä»¶
- æµç•…åœ°æ¼”ç¤ºæ‰€æœ‰åŠŸèƒ½
- è®²è§£æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ
- å±•ç¤ºä»£ç ç»„ç»‡ç»“æ„

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **ç¬¬ 1 å‘¨**ï¼šå®ŒæˆåŸºç¡€åŠŸèƒ½å¼€å‘
2. **ç¬¬ 2 å‘¨**ï¼šæ·»åŠ ç¼©ç•¥å›¾å’Œå¿«æ·é”®
3. **ç¬¬ 3 å‘¨**ï¼šä¼˜åŒ–æ€§èƒ½å’Œå“åº”å¼
4. **ç¬¬ 4 å‘¨**ï¼šæ·»åŠ æ‰©å±•åŠŸèƒ½
5. **ç¬¬ 5 å‘¨**ï¼šå®Œå–„æ–‡æ¡£å’Œæµ‹è¯•
6. **ç¬¬ 6 å‘¨**ï¼šéƒ¨ç½²ä¸Šçº¿å’Œå‡†å¤‡é¢è¯•

---

## å¸¸è§é—®é¢˜

### Q1: PDF.js Worker è·¯å¾„é…ç½®é—®é¢˜ï¼Ÿ

**A**: ç¡®ä¿ Worker è·¯å¾„æ­£ç¡®ï¼š

```javascript
// å¼€å‘ç¯å¢ƒä½¿ç”¨CDN
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

// ç”Ÿäº§ç¯å¢ƒå¯ä»¥æœ¬åœ°å¼•å…¥
```

### Q2: PDF åŠ è½½è·¨åŸŸé—®é¢˜ï¼Ÿ

**A**:

- ç¡®ä¿ PDF èµ„æºæ”¯æŒ CORS
- å¼€å‘æ—¶å¯ä»¥ä½¿ç”¨æœ¬åœ°ä»£ç†
- æˆ–è€…ä½¿ç”¨ Vite çš„ä»£ç†é…ç½®

### Q3: Canvas æ¸²æŸ“æ¨¡ç³Šï¼Ÿ

**A**:

```javascript
// ä½¿ç”¨devicePixelRatioæé«˜æ¸…æ™°åº¦
const scale = window.devicePixelRatio;
canvas.width = viewport.width * scale;
canvas.height = viewport.height * scale;
canvas.style.width = viewport.width + "px";
canvas.style.height = viewport.height + "px";
ctx.scale(scale, scale);
```

---

## æ€»ç»“

è¿™ä¸ª PDF é¢„è§ˆæ’ä»¶é¡¹ç›®æ˜¯ä¸€ä¸ªéå¸¸é€‚åˆå±•ç¤ºå‰ç«¯èƒ½åŠ›çš„å®æˆ˜é¡¹ç›®ã€‚é€šè¿‡å®Œæˆè¿™ä¸ªé¡¹ç›®ï¼Œä½ å°†ï¼š

âœ… æŒæ¡ Vue3 çš„æ ¸å¿ƒç‰¹æ€§
âœ… ç†è§£ Canvas API çš„ä½¿ç”¨
âœ… å­¦ä¼šå¤„ç†å¼‚æ­¥ç¼–ç¨‹
âœ… æå‡ä»£ç ç»„ç»‡èƒ½åŠ›
âœ… ç§¯ç´¯å®æˆ˜ç»éªŒ

**ç¥ä½ æ±‚èŒé¡ºåˆ©ï¼åŠ æ²¹ï¼ğŸ’ª**

---

å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶æé—®å’Œäº¤æµï¼
